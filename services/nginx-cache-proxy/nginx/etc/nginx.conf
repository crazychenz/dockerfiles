user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log debug;
pid        /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  log_format  main  '$remote_addr - $http_host [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

  access_log  /var/log/nginx/access.log  main;
  #error_log  /var/log/nginx/error.log  debug;

  sendfile        on;
  #tcp_nopush     on;

  keepalive_timeout  65;

  #gzip  on;

  # Cache locations on disk per "domain"
  proxy_cache_path /opt/nginx/cache/pypi levels=1:2 keys_zone=pypi:10m inactive=365d max_size=10g;
  proxy_cache_path /opt/nginx/cache/npm levels=1:2 keys_zone=npm:10m inactive=365d max_size=10g;
  proxy_cache_path /opt/nginx/cache/yarn levels=1:2 keys_zone=yarn:10m inactive=365d max_size=10g;
  proxy_cache_path /opt/nginx/cache/ubuntu levels=1:2 keys_zone=ubuntu:10m inactive=365d max_size=10g;
  proxy_cache_path /opt/nginx/cache/debian levels=1:2 keys_zone=debian:10m inactive=365d max_size=10g;
  proxy_cache_path /opt/nginx/cache/centos levels=1:2 keys_zone=centos:10m inactive=365d max_size=10g;
  proxy_cache_path /opt/nginx/cache/redhat levels=1:2 keys_zone=redhat:10m inactive=365d max_size=10g;
  proxy_cache_path /opt/nginx/cache/alpine levels=1:2 keys_zone=alpine:10m inactive=365d max_size=10g;
  
  server {
    listen 80;
    server_name dockerhost;

    # Route ubuntu caching based on file extensions.
    # - Save package files for up to a year.
    # - Save package meta data for up to a day.
    # - Note: 'archive' included incase we want to use 'security' in future.
    location ~ /cache/try/(.*)$ {

      # NPM Routing
      rewrite ^/cache/try/npm/(.*\.(tgz|tar\.gz))$ /cache/yearly/npm/$1?$args last;
      rewrite ^/cache/try/npm/(.*)$ /cache/daily/npm/$1?$args last;

      # Yarn Routing
      rewrite ^/cache/try/yarn/(.*\.(tgz|tar\.gz))$ /cache/yearly/yarn/$1?$args last;
      rewrite ^/cache/try/yarn/(.*)$ /cache/daily/yarn/$1?$args last;

      # Pypi Routing
      rewrite ^/cache/try/pypi/(.*\.(tgz|tar\.gz|whl|zip|tar\.bz2|tar\.xz))$ /cache/yearly/pypi/$1?$args last;
      rewrite ^/cache/try/pypi/(.*)$ /cache/daily/pypi/$1?$args last;

      # Ubuntu DEB Routing
      # https://launchpad.net/ubuntu/+archivemirrors
      rewrite ^/cache/try/ubuntu/archive/(.*\.(dsc|deb|tar\.xz|tar\.bz2|tar\.gz))$ /cache/yearly/ubuntu/archive/$1?$args last;
      rewrite ^/cache/try/ubuntu/archive/(.*)$ /cache/daily/ubuntu/archive/$1?$args last;
      # Note: security redirects to archive for mirror.pulsant.com mirror.
      rewrite ^/cache/try/ubuntu/security/(.*\.(dsc|deb|tar\.xz|tar\.bz2|tar\.gz))$ /cache/yearly/ubuntu/archive/$1?$args last;
      rewrite ^/cache/try/ubuntu/security/(.*)$ /cache/daily/ubuntu/archive/$1?$args last;

      # Debian DEB Routing
      rewrite ^/cache/try/debian/archive/(.*\.(dsc|deb|tar\.xz|tar\.bz2|tar\.gz))$ /cache/yearly/debian/archive/$1?$args last;
      rewrite ^/cache/try/debian/archive/(.*)$ /cache/daily/debian/archive/$1?$args last;
      # Note: deb.debian.org/debian-security automatically redirects to security.debian.org
      rewrite ^/cache/try/debian/security/(.*\.(dsc|deb|tar\.xz|tar\.bz2|tar\.gz))$ /cache/yearly/debian/archive/$1?$args last;
      rewrite ^/cache/try/debian/security/(.*)$ /cache/daily/debian/archive/$1?$args last;

      # CentOS RPM Routing
      # https://www.centos.org/download/mirrors/
      rewrite ^/cache/try/centos/(.*\.(rpm))$ /cache/yearly/centos/$1?$args last;
      rewrite ^/cache/try/centos/(.*)$ /cache/daily/centos/$1?$args last;
      
      # Redhat/UBI Routing
      rewrite ^/cache/try/redhat/(.*\.(rpm))$ /cache/yearly/redhat/$1?$args last;
      rewrite ^/cache/try/redhat/(.*)$ /cache/daily/redhat/$1?$args last;
      
      # Alpine APK Routing
      rewrite ^/cache/try/alpine/(.*\.(apk))$ /cache/yearly/alpine/$1?$args last;
      rewrite ^/cache/try/alpine/(.*)$ /cache/daily/alpine/$1?$args last;
    }

    # Services to consider
    # https://services.gradle.org/ -> yearly(.zip|.sha256)
    # https://www.jitpack.io (Maven)

    location /cache/daily/alpine/ {
      proxy_pass https://dl-cdn.alpinelinux.org/;
      proxy_cache alpine;
      proxy_temp_path /opt/nginx/cache/tmp/alpine 1 2;
      proxy_cache_valid "1d";
    
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    
    location /cache/yearly/alpine/ {
      proxy_pass https://dl-cdn.alpinelinux.org/;
      proxy_cache alpine;
      proxy_temp_path /opt/nginx/cache/tmp/alpine 1 2;
      proxy_cache_valid "365d";

      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }


    location /cache/daily/redhat/ {
      proxy_pass https://cdn-ubi.redhat.com/;
      proxy_cache redhat;
      proxy_temp_path /opt/nginx/cache/tmp/redhat 1 2;
      proxy_cache_valid "1d";
    
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    
    location /cache/yearly/redhat/ {
      proxy_pass https://cdn-ubi.redhat.com/;
      proxy_cache redhat;
      proxy_temp_path /opt/nginx/cache/tmp/redhat 1 2;
      proxy_cache_valid "365d";

      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }


    location /cache/daily/centos/ {
      # http://vault.centos.org
      proxy_pass https://southfront.mm.fcix.net/;
      proxy_cache centos;
      proxy_temp_path /opt/nginx/cache/tmp/centos 1 2;
      proxy_cache_valid "1d";
    
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    
    location /cache/yearly/centos/ {
      # http://vault.centos.org
      proxy_pass https://southfront.mm.fcix.net/;
      proxy_cache centos;
      proxy_temp_path /opt/nginx/cache/tmp/centos 1 2;
      proxy_cache_valid "365d";

      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    # Example URI: /sites/ubuntu-archive/dists/focal/Release
    # Example Dockerfile fixup:    
    #RUN echo '\n\
    #deb http://dockerhost:9876/cache/ubuntu-archive/sites/ubuntu-archive/ focal main restricted\n\
    #deb http://dockerhost:9876/cache/ubuntu-archive/sites/ubuntu-archive/ focal-updates main restricted\n\
    #deb http://dockerhost:9876/cache/ubuntu-archive/sites/ubuntu-archive/ focal universe\n\
    #deb http://dockerhost:9876/cache/ubuntu-archive/sites/ubuntu-archive/ focal-updates universe\n\
    #deb http://dockerhost:9876/cache/ubuntu-archive/sites/ubuntu-archive/ focal multiverse\n\
    #deb http://dockerhost:9876/cache/ubuntu-archive/sites/ubuntu-archive/ focal-updates multiverse\n\
    #deb http://dockerhost:9876/cache/ubuntu-archive/sites/ubuntu-archive/ focal-backports main restricted universe multiverse\n\
    #deb http://dockerhost:9876/cache/ubuntu-security/sites/ubuntu-archive/ focal-security main restricted\n\
    #deb http://dockerhost:9876/cache/ubuntu-security/sites/ubuntu-archive/ focal-security universe\n\
    #deb http://dockerhost:9876/cache/ubuntu-security/sites/ubuntu-archive/ focal-security multiverse\n' > /tmp/sources.list
    #RUN cat /etc/apt/sources.list >> /tmp/sources.list
    #RUN mv /tmp/sources.list /etc/apt/sources.list

    location /cache/daily/ubuntu/archive/ {
      proxy_pass https://mirror.pulsant.com/;
      proxy_cache ubuntu;
      proxy_temp_path /opt/nginx/cache/tmp/ubuntu 1 2;
      proxy_cache_valid "1d";
    
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    # Example URI: /sites/ubuntu-archive/pool/multiverse/3/3dldf-doc/3dldf-doc_2.0.3%2Bndfsg-2_all.deb
    location /cache/yearly/ubuntu/archive/ {
      proxy_pass https://mirror.pulsant.com/;      
      proxy_cache ubuntu;
      proxy_temp_path /opt/nginx/cache/tmp/ubuntu 1 2;
      proxy_cache_valid "365d";

      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    # Example URI: /sites/ubuntu-archive/dists/focal/Release
    location /cache/daily/debian/archive/ {
      proxy_pass http://deb.debian.org/;
      proxy_cache debian;
      proxy_temp_path /opt/nginx/cache/tmp/debian 1 2;
      proxy_cache_valid "1d";
    
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    # Example URI: /sites/ubuntu-archive/pool/multiverse/3/3dldf-doc/3dldf-doc_2.0.3%2Bndfsg-2_all.deb
    location /cache/yearly/debian/archive/ {
      proxy_pass https://deb.debian.org/;      
      proxy_cache debian;
      proxy_temp_path /opt/nginx/cache/tmp/debian 1 2;
      proxy_cache_valid "365d";

      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
      access_log off;
    }

    # Upstream NPM Packaging
    # Example URI: /fast-glob/-/fast-glob-3.2.12.tgz
    # TODO: For fine grain caching use *.tgz, *.tar.gz
    # npm config set registry http://dockerhost:9876/cache/try/npm/
    # NPM_CONFIG_REGISTRY=http://dockerhost:9876/cache/try/npm/
    # echo 'registry = "http://dockerhost:9876/cache/try/npm/"' > ~/.npmrc
    location /cache/yearly/npm/ {
      proxy_pass https://registry.npmjs.org/;
      proxy_cache npm;
      proxy_temp_path /opt/nginx/cache/tmp/npm 1 2;
      proxy_cache_valid 365d;
      
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    }

    # (Daily) Upstream NPM Packaging
    location /cache/daily/npm/ {
      proxy_pass https://registry.npmjs.org/;
      proxy_cache npm;
      proxy_temp_path /opt/nginx/cache/tmp/npm 1 2;
      proxy_cache_valid 1d;
      
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    }

    # Upstream NPM Packaging
    # Example URI: /fast-glob/-/fast-glob-3.2.12.tgz
    # TODO: For fine grain caching use *.tgz, *.tar.gz
    # yarn config set registry http://dockerhost:9876/cache/try/yarn/
    # yarn config set npmRegistryServer http://dockerhost:9876/cache/try/yarn/
    # YARN_REGISTRY=http://dockerhost:9876/cache/try/yarn/
    # echo 'registry = "http://dockerhost:9876/cache/try/yarn/"' > ~/.yarnrc
    location /cache/yearly/yarn/ {
      proxy_pass https://registry.yarnpkg.com/;
      proxy_cache yarn;
      proxy_temp_path /opt/nginx/cache/tmp/yarn 1 2;
      proxy_cache_valid 365d;
      
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    }

    # (Daily) Upstream NPM Packaging
    location /cache/daily/yarn/ {
      proxy_pass https://registry.yarnpkg.com/;
      proxy_cache yarn;
      proxy_temp_path /opt/nginx/cache/tmp/yarn 1 2;
      proxy_cache_valid 1d;
      
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    }

    # Upstream Python Packaging
    # Example URI: /packages/59/00/30e33fcd2a4562cd40c49c7740881009240c5cbbc0e41ca79ca4bba7c24b/PyYAML-6.0-cp311-cp311-win_amd64.whl
    # TODO: For fine grain caching use *.whl, *.tgz, *.tar.gz
    location /cache/yearly/pypi/ {
      proxy_pass https://files.pythonhosted.org/;
      proxy_cache pypi;
      proxy_temp_path /opt/nginx/cache/tmp/pypi 1 2;
      proxy_cache_valid 365d;
      
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    }

    # (Daily) Upstream Python Packaging
    location /cache/daily/pypi/ {
      proxy_pass https://files.pythonhosted.org/;
      proxy_cache pypi;
      proxy_temp_path /opt/nginx/cache/tmp/pypi 1 2;
      proxy_cache_valid 1d;
      
      resolver 1.1.1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host $proxy_host;
      proxy_ignore_headers X-Accel-Expires Expires Cache-Control;
      add_header X-Cache-Status $upstream_cache_status; # HIT / MISS / BYPASS / EXPIRED
      proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    }

  }
}